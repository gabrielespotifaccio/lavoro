<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Posting Map Platform</title>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    
    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #F8F9FA;
            --accent-color: #FF5733;
            --background-color: #FFFFFF;
            --text-color: #212529;
            --border-color: #DEE2E6;
            --success-color: #28a745;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            color: var(--text-color);
            background-color: var(--background-color);
            line-height: 1.6;
            padding: var(--spacing-md);
        }

        header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        h2 {
            font-size: 22px;
            margin-bottom: var(--spacing-md);
        }

        p {
            font-size: 14px;
            margin-bottom: var(--spacing-md);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--spacing-lg);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .form-section {
            padding: var(--spacing-md);
            background-color: var(--secondary-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .map-section {
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: bold;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .popup {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: var(--spacing-md);
            width: 250px;
        }

        .popup h3 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            font-size: 16px;
        }

        .popup .company {
            font-weight: bold;
            margin-bottom: var(--spacing-sm);
        }

        .popup .description {
            margin-bottom: var(--spacing-sm);
            font-size: 13px;
        }

        .popup .date {
            font-size: 12px;
            color: #666;
            text-align: right;
        }
        
        .overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .success-message {
            background-color: var(--success-color);
            color: white;
            padding: var(--spacing-lg);
            border-radius: 8px;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .job-list {
            margin-top: var(--spacing-lg);
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: var(--spacing-sm);
        }
        
        .job-item {
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .job-item:hover {
            background-color: var(--secondary-color);
        }
        
        .job-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: var(--spacing-md);
        }
        
        .error-message {
            color: var(--accent-color);
            margin-top: var(--spacing-sm);
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="overlay-container" id="successOverlay">
        <div class="success-message">
            <h3>Job Posted Successfully!</h3>
            <p>Your job has been added to the map.</p>
        </div>
    </div>

    <header>
        <h1>Job Posting Map Platform</h1>
        <p>Post and discover job vacancies on an interactive map</p>
    </header>

    <div class="container">
        <section class="form-section">
            <h2>Post a New Job</h2>
            <form id="jobForm">
                <div class="form-group">
                    <label for="jobTitle">Job Title*</label>
                    <input type="text" id="jobTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="company">Company Name*</label>
                    <input type="text" id="company" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Job Description*</label>
                    <textarea id="description" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="googleMapsLink">Google Maps Link*</label>
                    <input type="url" id="googleMapsLink" placeholder="https://maps.google.com/?q=..." required>
                    <div class="error-message" id="linkError">Please enter a valid Google Maps link</div>
                </div>
                
                <button type="submit">Post Job</button>
                <div class="loading" id="loadingIndicator">Posting job...</div>
            </form>
            
            <div class="job-list" id="jobList">
                <h3>Recent Job Postings</h3>
                <!-- Job items will be dynamically added here -->
            </div>
        </section>
        
        <section class="map-section">
            <div id="map"></div>
        </section>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://jlwhzoesyqsyzdkdpebc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impsd2h6b2VzeXFzeXpka2RwZWJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ0OTU0MTQsImV4cCI6MjA2MDA3MTQxNH0.ifvHUkBGLTjJlOvYE0dfMJDbGVFUC0MtvdUfNAPwKwc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Map initialization
        let map;
        let jobMarkers = [];
        let popupOverlay;
        
        function initMap() {
            // Create a popup overlay
            const popupElement = document.createElement('div');
            popupElement.className = 'popup';
            
            popupOverlay = new ol.Overlay({
                element: popupElement,
                positioning: 'bottom-center',
                stopEvent: false,
                offset: [0, -10]
            });
            
            // Initialize map
            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                overlays: [popupOverlay],
                view: new ol.View({
                    center: ol.proj.fromLonLat([12.4964, 41.9028]), // Default center on Rome, Italy
                    zoom: 5
                })
            });
            
            // Add click interaction to show job details
            map.on('click', function(evt) {
                const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                    return feature;
                });
                
                if (feature) {
                    const jobData = feature.get('jobData');
                    if (jobData) {
                        const coordinates = feature.getGeometry().getCoordinates();
                        
                        // Format date
                        const date = new Date(jobData.created_at);
                        const formattedDate = date.toLocaleDateString();
                        
                        // Set popup content
                        popupElement.innerHTML = `
                            <h3>${jobData.title}</h3>
                            <div class="company">${jobData.company}</div>
                            <div class="description">${jobData.description}</div>
                            <div class="date">Posted: ${formattedDate}</div>
                        `;
                        
                        popupOverlay.setPosition(coordinates);
                    }
                } else {
                    popupOverlay.setPosition(undefined);
                }
            });
            
            // Close popup when clicking elsewhere
            map.on('pointermove', function(evt) {
                const hit = map.hasFeatureAtPixel(evt.pixel);
                map.getTargetElement().style.cursor = hit ? 'pointer' : '';
            });
            
            // Load existing jobs
            loadJobs();
        }
        
        // Function to extract coordinates from Google Maps link
        function extractCoordinatesFromLink(link) {
            try {
                // Handle various Google Maps URL formats
                let url = new URL(link);
                
                // Format: https://maps.google.com/?q=lat,lng
                if (url.searchParams.has('q')) {
                    const qParam = url.searchParams.get('q');
                    const latLngMatch = qParam.match(/([-+]?\d+\.\d+),([-+]?\d+\.\d+)/);
                    
                    if (latLngMatch) {
                        return {
                            latitude: parseFloat(latLngMatch[1]),
                            longitude: parseFloat(latLngMatch[2])
                        };
                    }
                }
                
                // Format: https://www.google.com/maps/@lat,lng,zoom
                const pathMatch = url.pathname.match(/@([-+]?\d+\.\d+),([-+]?\d+\.\d+)/);
                if (pathMatch) {
                    return {
                        latitude: parseFloat(pathMatch[1]),
                        longitude: parseFloat(pathMatch[2])
                    };
                }
                
                // Format: https://www.google.com/maps/place/.../@lat,lng,zoom/
                const placeMatch = url.toString().match(/@([-+]?\d+\.\d+),([-+]?\d+\.\d+)/);
                if (placeMatch) {
                    return {
                        latitude: parseFloat(placeMatch[1]),
                        longitude: parseFloat(placeMatch[2])
                    };
                }
                
                return null;
            } catch (error) {
                console.error("Error parsing Google Maps link:", error);
                return null;
            }
        }
        
        // Function to add markers for jobs
        function addJobMarkers(jobs) {
            // Clear existing markers
            jobMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            jobMarkers = [];
            
            // Create markers for each job
            jobs.forEach(job => {
                if (job.latitude && job.longitude) {
                    const coordinates = ol.proj.fromLonLat([job.longitude, job.latitude]);
                    
                    // Create marker feature
                    const markerFeature = new ol.Feature({
                        geometry: new ol.geom.Point(coordinates),
                        jobData: job
                    });
                    
                    // Style for the marker
                    const markerStyle = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 8,
                            fill: new ol.style.Fill({ color: '#007BFF' }),
                            stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                        })
                    });
                    
                    markerFeature.setStyle(markerStyle);
                    
                    // Add marker to the map
                    const vectorLayer = new ol.layer.Vector({
                        source: new ol.source.Vector({
                            features: [markerFeature]
                        })
                    });
                    
                    map.addLayer(vectorLayer);
                    jobMarkers.push(vectorLayer);
                }
            });
        }
        
        // Function to load jobs from Supabase
        async function loadJobs() {
            try {
                const { data, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error("Error loading jobs:", error);
                    return;
                }
                
                // Add markers to the map
                addJobMarkers(data);
                
                // Update job list
                updateJobList(data);
            } catch (error) {
                console.error("Failed to load jobs:", error);
            }
        }
        
        // Function to update the job list sidebar
        function updateJobList(jobs) {
            const jobList = document.getElementById('jobList');
            
            if (jobs.length === 0) {
                jobList.innerHTML = `<h3>Recent Job Postings</h3><p>No jobs posted yet.</p>`;
                return;
            }
            
            const jobItems = jobs.slice(0, 10).map(job => {
                const date = new Date(job.created_at);
                return `
                    <div class="job-item" data-id="${job.id}">
                        <strong>${job.title}</strong>
                        <div>${job.company}</div>
                        <small>${date.toLocaleDateString()}</small>
                    </div>
                `;
            }).join('');
            
            jobList.innerHTML = `<h3>Recent Job Postings</h3>${jobItems}`;
            
            // Add click handlers to job items
            document.querySelectorAll('.job-item').forEach(item => {
                item.addEventListener('click', () => {
                    const jobId = item.getAttribute('data-id');
                    const job = jobs.find(j => j.id == jobId);
                    
                    if (job && job.latitude && job.longitude) {
                        // Center map on the job location
                        map.getView().animate({
                            center: ol.proj.fromLonLat([job.longitude, job.latitude]),
                            zoom: 12,
                            duration: 1000
                        });
                        
                        // Find and click the feature to show the popup
                        setTimeout(() => {
                            const pixel = map.getPixelFromCoordinate(
                                ol.proj.fromLonLat([job.longitude, job.latitude])
                            );
                            if (pixel) {
                                const feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                                    return feature;
                                });
                                
                                if (feature) {
                                    const coordinates = feature.getGeometry().getCoordinates();
                                    popupOverlay.setPosition(coordinates);
                                    
                                    // Set popup content
                                    const popupElement = popupOverlay.getElement();
                                    const date = new Date(job.created_at);
                                    
                                    popupElement.innerHTML = `
                                        <h3>${job.title}</h3>
                                        <div class="company">${job.company}</div>
                                        <div class="description">${job.description}</div>
                                        <div class="date">Posted: ${date.toLocaleDateString()}</div>
                                    `;
                                }
                            }
                        }, 1100);
                    }
                });
            });
        }
        
        // Function to submit a new job
        async function submitJob(formData) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            try {
                const { data, error } = await supabase
                    .from('jobs')
                    .insert([formData])
                    .select();
                
                loadingIndicator.style.display = 'none';
                
                if (error) {
                    console.error("Error submitting job:", error);
                    return false;
                }
                
                // Show success message
                const successOverlay = document.getElementById('successOverlay');
                successOverlay.style.display = 'flex';
                setTimeout(() => {
                    successOverlay.style.display = 'none';
                }, 3000);
                
                // Reload jobs
                loadJobs();
                
                return true;
            } catch (error) {
                loadingIndicator.style.display = 'none';
                console.error("Failed to submit job:", error);
                return false;
            }
        }
        
        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            initMap();
            
            // Handle form submission
            const jobForm = document.getElementById('jobForm');
            const linkError = document.getElementById('linkError');
            
            jobForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const jobTitle = document.getElementById('jobTitle').value;
                const company = document.getElementById('company').value;
                const description = document.getElementById('description').value;
                const googleMapsLink = document.getElementById('googleMapsLink').value;
                
                // Extract coordinates from the Google Maps link
                const coordinates = extractCoordinatesFromLink(googleMapsLink);
                
                if (!coordinates) {
                    linkError.style.display = 'block';
                    return;
                }
                
                linkError.style.display = 'none';
                
                // Prepare form data
                const formData = {
                    title: jobTitle,
                    company: company,
                    description: description,
                    latitude: coordinates.latitude,
                    longitude: coordinates.longitude,
                    created_at: new Date().toISOString()
                };
                
                // Submit the job
                const success = await submitJob(formData);
                
                if (success) {
                    // Clear form
                    jobForm.reset();
                    
                    // Center map on the new job location
                    map.getView().animate({
                        center: ol.proj.fromLonLat([coordinates.longitude, coordinates.latitude]),
                        zoom: 10,
                        duration: 1000
                    });
                }
            });
        });
    </script>
</body>
</html>
